/**
 * @fileoverview Implementa a funcionalidade de busca com correspondência fuzzy para destinos de viagem.
 * Utiliza Fuse.js para pesquisa aproximada e cálculo de relevância ponderada baseada em características dos destinos.
 * @author CESINHAFX
 * @version 1.0.0
 */

import Fuse from 'https://cdn.jsdelivr.net/npm/fuse.js@6.6.2/dist/fuse.esm.js';

/**
 * Configurações para o mecanismo de busca Fuse.js
 * @constant {Object} searchOptions
 * @property {boolean} includeScore - Indica se deve incluir pontuação de relevância nos resultados
 * @property {Array<string>} keys - Campos nos quais realizar a busca
 * @property {number} threshold - Limite de precisão da busca (0 = exato, 1 = qualquer match)
 * @property {number} distance - Distância máxima de Levenshtein para considerar uma correspondência
 */
// Configurações da biblioteca Fuse.js para busca fuzzy
// Opções para o Fuse.js (biblioteca de busca fuzzy)
// Por que: definimos aqui como a busca vai ponderar e onde procurar os termos.
// Dependência: Fuse.js (import acima) e o arquivo `database.json` para os dados.
const searchOptions = {
  includeScore: true,
  keys: ['description', 'name', 'categories'],
  threshold: 0.4
};

// Ensure a global flag is available for coordination with non-module fragments loader
window.headerInitialized = window.headerInitialized ?? false;

// Expose a setup function so the non-module fragments loader can call it after injecting header
window.setupHeaderButtons = function setupHeaderButtons() {
  try {
    if (window.headerInitialized) {
      console.log('[DEBUG] Header already initialized, ignoring setupHeaderButtons');
      return;
    }
    window.headerInitialized = true;

    const searchInput = document.querySelector('#Research') || document.querySelector('.nav-right input[type="text"]');
    if (!searchInput) {
      console.warn('setupHeaderButtons: campo de busca (#Research) não encontrado.');
      return;
    }

    // Ensure results container exists and is consistent
    let resultsContainer = document.getElementById('results') || document.querySelector('.search-results');
    if (!resultsContainer) {
      resultsContainer = document.createElement('div');
      resultsContainer.id = 'results';
      resultsContainer.className = 'search-results';
      const main = document.querySelector('main');
      if (main) main.appendChild(resultsContainer);
      else if (searchInput.parentNode) searchInput.parentNode.appendChild(resultsContainer);
    }

    // Debounced input handler
    let debounceTimer;
    searchInput.addEventListener('input', (e) => {
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(() => {
        const term = e.target.value.trim();
        if (term.length >= 3) {
          if (typeof searchDestinations === 'function') searchDestinations(term);
        } else {
          resultsContainer.innerHTML = '';
        }
      }, 300);
    });

    console.log('[DEBUG] setupHeaderButtons completed');
  } catch (err) {
    console.error('setupHeaderButtons error:', err);
  }
};

// Replace DOMContentLoaded initialization to call the exposed setup function
document.addEventListener('DOMContentLoaded', () => {
  try {
    if (typeof window.setupHeaderButtons === 'function') {
      window.setupHeaderButtons();
    }
  } catch (e) {
    console.error('Erro ao executar setupHeaderButtons no DOMContentLoaded:', e);
  }
});